const qrcode = require('qrcode-terminal');
const { Client, LocalAuth, Buttons, List, MessageMedia } = require('whatsapp-web.js');

const client = new Client({
    authStrategy: new LocalAuth()
});


const userStates = new Map();
const userTimeouts = new Map();

const delay = ms => new Promise(res => setTimeout(res, ms));

function setUserState(userId, state, isAluno = null) {
    const current = userStates.get(userId) || {};
    userStates.set(userId, { ...current, state, ...(isAluno !== null && { isAluno }) });
}

function getUserState(userId) {
    return userStates.get(userId) || { state: 'inicio' };
}

function timeoutHandler(chat, timeoutDuration, userId) {
    // Cancela o timeout anterior se existir
    const existingTimeout = userTimeouts.get(userId);
    if (existingTimeout) {
        clearTimeout(existingTimeout);
    }

    // Cria novo timeout
    const timeoutId = setTimeout(async () => {
        await chat.sendMessage('O atendimento ser√° encerrado por inatividade. Caso precise de mais assist√™ncia, por favor entre em contato novamente.');
        userStates.delete(userId);
        userTimeouts.delete(userId);
    }, timeoutDuration);

    userTimeouts.set(userId, timeoutId);
}

async function endAttending(msg, chat) {
    const timeoutId = userTimeouts.get(msg.from);
    if (timeoutId) {
        clearTimeout(timeoutId);
        userTimeouts.delete(msg.from);
    }
    userStates.delete(msg.from);
    await chat.sendMessage('O atendimento foi encerrado. Caso precise de mais ajuda, entre em contato novamente. At√© logo! üëã');
}

async function startAttending(msg, contactName, isAluno) {
    const chat = await msg.getChat();
    setUserState(msg.from, isAluno ? 'menu_aluno' : 'menu_nao_aluno', isAluno);

    await delay(3000);
    await chat.sendStateTyping();
    await delay(3000);

    const nome = typeof contactName === 'string' ? contactName.split(" ")[0] : 'usu√°rio';
    const menuAluno = `Ol√°, ${nome}! üëã\n\nSou o assistente virtual da Fametro Leste.\n\nPrezado(a) aluno(a), digite o n√∫mero correspondente ao atendimento que deseja:\n\n1 - Retorno de requerimentos\n2 - Financeiro\n3 - Declara√ß√µes ou hist√≥rico escolar\n4 - Justificativa de falta\n5 - P√≥s-gradua√ß√£o ou t√©cnico\n6 - Trabalhe conosco (Est√°gio/Emprego)\n7 - Cadastro/recadastro Carteirinha Estudantil\n8 - Assinatura do TCE\n9 - Cancelamento/Trancamento de matr√≠cula\n10 - Guia de Transfer√™ncia/Hist√≥rico e Ementas\n11 - Ouvidoria\n12 - Outras d√∫vidas\n\nDigite 'encerrar' a qualquer momento para finalizar o atendimento.`;

    const menuNaoAluno = `Ol√°, ${nome}! üëã\n\nSou o assistente virtual da Fametro Leste.\n\nPrezado(a), digite o n√∫mero correspondente ao atendimento que deseja:\n\n1 - Informa√ß√µes sobre os cursos\n2 - Formas de ingresso\n3 - Ouvidoria\n4 - Falar com um atendente\n\nDigite 'encerrar' a qualquer momento para finalizar o atendimento.`;

    await client.sendMessage(msg.from, isAluno ? menuAluno : menuNaoAluno);

    timeoutHandler(chat, 30 * 60 * 1000, msg.from);
}

async function openQuestionHandler(msg, contactName) {
    const chat = await msg.getChat();
    await delay(3000);
    await chat.sendStateTyping();
    await delay(3000);

    await client.sendMessage(msg.from,
        `>C√≥digo atendimento: AG0114#\n\nOl√°, ${contactName.split(" ")[0]}! üëã\n\nPor favor, digite sua d√∫vida abaixo. Assim que um de nossos atendentes estiver dispon√≠vel, ir√° te atender.\n\nDigite 'encerrar' a qualquer momento para finalizar o atendimento.`
    );

    timeoutHandler(chat, 60 * 60 * 1000, msg.from);
}


console.log("Iniciando cliente...");
client.on('qr', qr => qrcode.generate(qr, { small: true }));
client.on('ready', () => console.log('Tudo certo! WhatsApp conectado.'));
client.on('disconnected', reason => console.log('‚ùå Cliente desconectado. Motivo:', reason));
client.initialize();

const FSM = {
    'inicio': async (msg) => {
        if (/menu|oi|ol√°|ola|matr[i√≠]cula|curso|ajuda|d[√∫u]vida|quero|preciso/i.test(msg.body) || msg.body.length > 10) {
            await client.sendMessage(msg.from, 'Voc√™ √© aluno da Fametro Leste? Responda com "sim" ou "n√£o".');
            setUserState(msg.from, 'confirmando_aluno');
        }
    },
    'confirmando_aluno': async (msg, chat, name) => {
        const answer = msg.body.toLowerCase();
        if (answer === 'sim') {
            await startAttending(msg, name, true);
        } else if (["n√£o", "nao"].includes(answer)) {
            await startAttending(msg, name, false);
        } else {
            await client.sendMessage(msg.from, 'Por favor, responda apenas com "sim" ou "n√£o".');
        }
    },
    'menu_aluno': async (msg, chat) => await handleAlunoMenu(msg, chat),
    'menu_nao_aluno': async (msg, chat) => await handleNaoAlunoMenu(msg, chat),
    'esperando_dados_requerimento': async (msg, chat) => {
    await chat.sendStateTyping();
    await delay(1500);
    await client.sendMessage(msg.from, '> C√≥digo atendimento: RQM01#\n\nCerto, obrigado pelas informa√ß√µes! Em breve um de nossos atendentes ir√° te responder. üïê');
    //setUserState(msg.from, 'menu_aluno');
    timeoutHandler(chat, 30 * 60 * 1000, msg.from);
    },
    'esperando_dados_financeiro': async (msg, chat) => {
    await chat.sendStateTyping();
    await delay(1500);
    await client.sendMessage(msg.from, '> C√≥digo atendimento: FNC02#\n\nCerto, obrigado pelas informa√ß√µes! Em breve um de nossos atendentes ir√° te responder. üïê');
    //setUserState(msg.from, 'menu_aluno');
    timeoutHandler(chat, 30 * 60 * 1000, msg.from);
    },
    'aguardando_dados': async (msg, chat) => {
        const data = msg.body;
        await chat.sendStateTyping();
        await delay(1500);
        await client.sendMessage(msg.from, `> C√≥digo inclus√£o: EMPRE06#\n\nCerto, obrigada pelas informa√ß√µes!\nDigite "encerrar" para iniciar uma nova intera√ß√£o.`);
        timeoutHandler(chat, 30 * 60 * 1000, msg.from);
    },
    'aguardando_dados_TCE': async (msg, chat) => {
        const data = msg.body;
        await chat.sendStateTyping();
        await delay(1500);
        await client.sendMessage(msg.from, `> C√≥digo atendimento: ATCE08#\n\nCerto, obrigada pelas informa√ß√µes!\nDigite "encerrar" para iniciar uma nova intera√ß√£o.`);
        timeoutHandler(chat, 30 * 60 * 1000, msg.from);
    }
};

// Objeto de sess√µes dos usu√°rios
//const userSessions = {};

const authorizedAgents = ['5592984336160@c.us']; // agente autorizado

function isAgent(number) {
    return authorizedAgents.includes(number);
}

// Quando o atendente assume
function setAttendingUser(userId, isBeingAttended = true) {
    userSessions[userId] = {
        ...userSessions[userId],
        beingAttended: isBeingAttended
    };
}

client.on('message', async msg => {
    const chat = await msg.getChat();
    if (msg.body.toLowerCase() === 'encerrar' && msg.from.endsWith('@c.us')) {
        await endAttending(msg, chat);
        return;
    }

    const user = getUserState(msg.from);
    const contact = await msg.getContact();
    const name = contact.pushname;

    if (chat.isGroup) {
        return;
    }

    const userId = msg.from;

     // ‚ö†Ô∏è Verifica se o remetente √© um atendente autorizado
     if (msg.body === '!atender' && isAgent(userId)) {
        if (msg.mentionedIds.length === 0) {
            msg.reply('‚ùó Voc√™ precisa marcar o n√∫mero do cliente para ativar o modo atendimento.');
            return;
        }

        const targetId = msg.mentionedIds[0];
        setAttendingUser(targetId, true);
        msg.reply(`üõë O bot foi pausado para ${targetId}.`);
        return;
    }

    if (msg.body === '!finalizar' && isAgent(userId)) {
        if (msg.mentionedIds.length === 0) {
            msg.reply('‚ùó Voc√™ precisa marcar o n√∫mero do cliente para finalizar o atendimento.');
            return;
        }

        const targetId = msg.mentionedIds[0];
        setAttendingUser(targetId, false);
        msg.reply(`‚úÖ O atendimento de ${targetId} foi finalizado. O bot voltou a responder.`);
        return;
    }

    // Se o usu√°rio est√° sendo atendido, o bot n√£o responde
    if (userSessions[userId]?.beingAttended) {
        console.log(`Usu√°rio ${userId} est√° em atendimento humano.`);
        return;
    }

    if (FSM[user.state]) {
        await FSM[user.state](msg, chat, name);
    }
});



async function handleAlunoMenu(msg, chat) {
    const introductions = {
        '1': 'üîé Vamos iniciar a verifica√ß√£o do seu requerimento.\n\nPor favor, envie os seguintes dados para que possamos verificar.',
        '2': 'üí∞ Vamos tratar das quest√µes financeiras.\n\nPor favor, envie os seguintes dados para que possamos verificar.',
        '3': 'üìÑ Vamos te ajudar com declara√ß√µes ou hist√≥rico escolar.',
        '4': 'üìù Vamos lhe ajudar sobre sua justificativa de falta.',
        '5': 'üéì *P√≥s-gradua√ß√£o ou cursos t√©cnicos.*',
        '6': 'üíº Veja como se candidatar a vagas de est√°gio.',
        '7': 'ü™™ Cadastro/Recadastro Carteirinha Estudantil\n\nPor favor, preencha o formul√°rio abaixo para que possamos aprovar sua meia-passagem.\n\nObs.: Somente para alunos de gradua√ß√£o. Caso seja ensino t√©cnico, procurar o setor Fametrotec Leste.',
        '8': 'üñäÔ∏è Vamos te ajudar com a assinatura do TCE.',
        '9': 'üö´ Informa√ß√µes sobre cancelamento ou trancamento de matr√≠cula.',
        '10': '> Guia de Transfer√™ncia\nPara solicitar guia de transfer√™ncia, se encaminhe ao setor NADI para a abertura do requerimento e oobten√ß√£o de maiores informa√ß√µes.',
        '11':'üì¢ Canal da Ouvidoria da institui√ß√£o  '
    };

    const responses = {
        '1': '‚Ä¢ Nome completo:\n‚Ä¢ CPF:\n‚Ä¢ N¬∫ de matr√≠cula:\n‚Ä¢ Qual requerimento deseja retorno:\n‚Ä¢ Data da solicita√ß√£o:',
        '2': '‚Ä¢ Nome completo:\n‚Ä¢ CPF:\n‚Ä¢ N¬∫ de matr√≠cula:\n‚Ä¢ Qual quest√£o financeira deseja que seja verificada?',
        '3': '> Declara√ß√£o de matr√≠cula/v√≠nculo:\n\nAcessar o Portal do aluno: https://sistemas.portaledu.com.br/FrameHTML/web/app/edu/PortalEducacional/login/\n>> Ir em "Relat√≥rios" \n>> Na op√ß√£o "02.00.05.3 - DECLARA√á√ÉO DE V√çNCULO (PORTAL) (GRADUA√á√ÉO)", clicar em "emitir relat√≥rio" para baixar diretamente no seu dispositivo, com isso poder√° tamb√©m imprimir o documento.',
        '30': '> Hist√≥rico escolar:\n\nAcessar o Portal do Aluno: https://sistemas.portaledu.com.br/FrameHTML/web/app/edu/PortalEducacional/login/\n>> Ir em "Secretaria", na op√ß√£o "Requerimentos"\n>> Selecionar a op√ß√£o "EDU - Hist√≥rico Escolar 1¬™ Via" (caso seja sua 1¬™ solicita√ßa√µ desse documento),\nou a op√ß√£o "EDU - Hist√≥rico Escolar 2¬™ Via" (caso seja sua 2¬™ ou + Via de requerimento)',
        '4': '> Justificativa de falta\n\nA documenta√ß√£o (declara√ß√£o ou atestado) deve ser entregue na secretaria presencialmente. Prazo de 72h para entrega presencial (discente ou um respons√°vel munido do atestado, RG e CPF originais do discente)',
        '40':'> Para alunos adventistas\n\nNecess√°rio entregar presencialmente a declara√ß√£o original com o carimbo e assinatura do respons√°vel da igreja.',
        '5': '> P√≥s gradua√ß√£o:\n\n Entre em contato pelo telefone:\n +55 92 8455-4303\n\n> T√©cnico Leste\n\nEntrar em contato pelo telefone:\n +55 92 8555-1125.',
        '6': 'üíº Comunidade Empremetro\n\nTodos os dias publicamos vagas de est√°gio e emprego - n√£o s√≥ de empresas parceiras, como tamb√©m de nossa institui√ß√£o - para que voc√™, nosso(a) prezado(a) aluno(a), possa se candidatar com mais facilidade e agilidade. Fique ligado(a) nas oportunidades! üòâ\nCaso n√£o fa√ßa parte da comunidade, envie seu nome completo e contato atualizado para inclu√≠rmos voc√™ em nossa comunidade\n\nCaso queira se cadastrar no banco de talento da Fametro Leste, acesse nosso formul√°rio e preencha suas informa√ß√µes: https://forms.gle/TL6DB3TcBGkJY4rj7\n\nDigite "encerrar" caso n√£o queira participar da comunidade Empremetro',
        '7': '> Formul√°rio de cadastro\n\nhttps://forms.gle/gBFTa5dw94ud1ToD7',
        '8': 'Por favor, compare√ßa com suas vias presencialmente para assinatura no setor NADI/CRA.\n\nImportante verificar:\n‚Ä¢ Se h√° mais de uma via, para que uma via fique na institui√ß√£o.\n‚Ä¢ Se todas as vias est√£o assinadas por voc√™ (discente).\n‚Ä¢ Se as informa√ß√µes da institui√ß√£o est√£o corretas na documenta√ß√£o, principalmente um nome de um *respons√°vel* da instui√ß√£o.\n\nCaso tenha sido enviado via e-mail, informe seu nome completo e n¬∫ de matr√≠cula para verificarmos, ou digite "encerrar" para finalizar esta intera√ß√£o.',
        '9': 'Prezado(a) aluno(a),\n\nSolicita√ß√µes de cancelamento/trancamento devem ser feitas presencialmente no setor NADI/CRA.\n\n *Obs.*: Informa√ß√µes complementares √† solicita√ß√£o de cancelamento e trancamento podem ser encontradas na Cl√°usula Oitava e Cl√°usula Nona de seu contrato de matr√≠cula, como tamb√©m ser√£o esclarecidas no ato do atendimento.',
        '10': '>Hist√≥rico e Ementas\nPara a solicita√ß√£o de Hist√≥rico e Ementas, √© necess√°rio se encaminhar ao setor SECAD onde ser√° feita a abertura da solicita√ß√£o da documenta√ß√£o. Tamb√©m pode ser feita a solicita√ß√£o atrav√©s do Portal do Aluno em >>Secretaria, >>Requerimentos, >>Op√ß√£o "EDU - Programa de Disciplinas".',
        '11': 'Acesse o link para realizar uma ouvidoria(Elogios, Sugest√µes, Cr√≠ticas e Informa√ß√µes): https://fametro.edu.br/ouvidoria/',
    };

    if (msg.body === '1') {
        await chat.sendStateTyping();
        await delay(1500);
        await client.sendMessage(msg.from, introductions['1']);
        await delay(1500);
        await chat.sendStateTyping();
        await delay(1500);
        await client.sendMessage(msg.from, responses['1']);
        setUserState(msg.from, 'esperando_dados_requerimento'); // Aguarda dados do aluno
        timeoutHandler(chat, 30 * 60 * 1000, msg.from);
    } else if (msg.body === '2') {
        await chat.sendStateTyping();
        await delay(1500);
        await client.sendMessage(msg.from, introductions['2']);
        await delay(1500);
        await chat.sendStateTyping();
        await delay(1500);
        await client.sendMessage(msg.from, responses['2']);
        setUserState(msg.from, 'esperando_dados_financeiro'); // Aguarda dados do aluno
        timeoutHandler(chat, 30 * 60 * 1000, msg.from);
    }  else if (msg.body === '3') {
        await chat.sendStateTyping();
        await delay(1500);
        await client.sendMessage(msg.from, introductions['3']);
        await delay(1500);
        await chat.sendStateTyping();
        await delay(1500);
        await client.sendMessage(msg.from, responses['3']);
        await delay(1500);
        await chat.sendStateTyping();
        await delay(3500);
        await client.sendMessage(msg.from, responses['30']);
        timeoutHandler(chat, 30 * 60 * 1000, msg.from);
    }  else if (msg.body === '4') {
        await chat.sendStateTyping();
        await delay(1500);
        await client.sendMessage(msg.from, introductions['4']);
        await delay(1500);
        await chat.sendStateTyping();
        await delay(1500);
        await client.sendMessage(msg.from, responses['4']);
        await delay(1500);
        await chat.sendStateTyping();
        await delay(3500);
        await client.sendMessage(msg.from, responses['40']);
        timeoutHandler(chat, 30 * 60 * 1000, msg.from);
    } else if (msg.body === '6') {
        await chat.sendStateTyping();
        await delay(1500);
        await client.sendMessage(msg.from, introductions['6']);
        await delay(1500);
        await chat.sendStateTyping();
        await delay(1500);
        await client.sendMessage(msg.from, responses['6']);
        setUserState(msg.from, 'aguardando_dados'); // Aguarda dados do aluno
        timeoutHandler(chat, 30 * 60 * 1000, msg.from);
    } else if (msg.body === '8') {
        await chat.sendStateTyping();
        await delay(1500);
        await client.sendMessage(msg.from, introductions['8']);
        await delay(1500);
        await chat.sendStateTyping();
        await delay(1500);
        await client.sendMessage(msg.from, responses['8']);
        setUserState(msg.from, 'aguardando_dados_TCE'); // Aguarda dados do aluno
        timeoutHandler(chat, 30 * 60 * 1000, msg.from);
    } else if (['5', '7', '9', '10', '11'].includes(msg.body)) {
        await chat.sendStateTyping();
        await delay(1500);
        await client.sendMessage(msg.from, introductions[msg.body]);
        await delay(1500);
        await chat.sendStateTyping();
        await delay(1500);
        await client.sendMessage(msg.from, responses[msg.body]);
        timeoutHandler(chat, 30 * 60 * 1000, msg.from);
    } else if (msg.body === '12') {
        const contact = await msg.getContact();
        await openQuestionHandler(msg, contact.pushname);
    } else {
        await client.sendMessage(msg.from, 'Digite "encerrar" caso queira iniciar uma nova intera√ß√£o.');
    }
}

async function handleNaoAlunoMenu(msg, chat) {
    const introductions = {
        '1': 'üìö Informa√ß√µes sobre os cursos oferecidos pela Fametro.\nDeixe seus dados para que possamos entrar em contato e lhe apresentar nosso cat√°logo de cursos!',
        '2': 'üõ£Ô∏è Vamos te mostrar as formas de ingresso dispon√≠veis.',
        '3': 'üì¢ Canal da Ouvidoria da institui√ß√£o.',
    };

    const responses = {
        '1': 'Nome completo, pretens√£o de curso ou somente o nome.',
        '2': '‚Ä¢ ENEM\n‚Ä¢ Fies\n‚Ä¢ PBU\n‚Ä¢ Vestibular Fametro (online ou presencial)\n‚Ä¢ Portador de Diploma\n‚Ä¢ Transfer√™ncia Externa',
        '3': 'Acesse o link para realizar uma ouvidoria(Elogios, Sugest√µes, Cr√≠ticas e Informa√ß√µes): https://fametro.edu.br/ouvidoria/',
    };

    if (responses[msg.body]) {
        await chat.sendStateTyping();
        await delay(1500);
        await client.sendMessage(msg.from, introductions[msg.body]);
        await delay(1500);
        await chat.sendStateTyping();
        await delay(1500);
        await client.sendMessage(msg.from, responses[msg.body]);
        timeoutHandler(chat, 30 * 60 * 1000, msg.from);
    } else if (msg.body === '4') {
        const contact = await msg.getContact();
        await openQuestionHandler(msg, contact.pushname);
    } else {
        await client.sendMessage(msg.from, 'Digite "encerrar" caso queira iniciar uma nova intera√ß√£o.');
    }
}
